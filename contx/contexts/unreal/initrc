export UNREAL_CONTEXT_DIR="$(dirname "$(realpath "$0")")"

# Move home to dedicated directory, so Unreal can put all his junk there
UNREAL_HOME=~/.unreal

# Find .uproject file in the current directory
UNREAL_PROJECT="$( \
  find "$PWD" -maxdepth 1 -type f -name '*.uproject' |
  head -n 1
)"
[[ -n "$UNREAL_PROJECT" ]] || error "no .uproject file found in '$PDW'"

# Read Unreal version from .uproject file
UNREAL_VERSION="$(jq -r .EngineAssociation < "$UNREAL_PROJECT")"

# Add Unreal scripts to path
UNREAL_PREFIX="/Users/Shared/Epic Games/UE_$UNREAL_VERSION"
[[ -d "$UNREAL_PREFIX" ]] ||
  echo >&2 "warning: Unreal $UNREAL_VERSION not found in '$UNREAL_PREFIX'"

UNREAL_BIN="$UNREAL_PREFIX/Engine/Build/BatchFiles"
PATH="$UNREAL_BIN:$UNREAL_BIN/Mac/:$PATH"

# Create a terminal window dedicated to vim
vim_window () {
  ps ax |
  grep "vim -c bw" |
  grep -vq grep ||
    alacritty msg create-window \
      --working-directory="$PWD/Source/$(basename "$PWD")" \
      -e vim -c 'bw' -u "$UNREAL_CONTEXT_DIR/vimrc"
}

# Open project in unreal editor (if not already open)
ue () {
  ps ax |
  grep "UnrealEditor $UNREAL_PROJECT" |
  grep -vq grep ||
    HOME="$UNREAL_HOME" open -na UnrealEditor --args "$UNREAL_PROJECT"
}

# Build C++ source
build () {
  local build_type platform target build_app
  [[ -z "$1" ]] || build_type="$1"
  [[ -z "$2" ]] || platform="$2"

  : ${build_type:=Development}
  : ${platform:=Mac}
  : ${build_app:=false}

  case "$build_type" in
    [Dd]evelopment)
      build_type=Development
      target=Editor
      ;;
    [Ss]hipping | [Rr]elease)
      build_type=Shipping
      target=Game
      ;;
    [Aa]pp)
      build_type=Shipping
      target=Game
      build_app=true
      ;;
    *) echo "Build type '$build_type' not supported" >&2
      return 1
      ;;
  esac

  Build.sh \
    "$platform" \
    "$build_type" \
    -Project="$UNREAL_PROJECT" \
    -TargetType="$target" \
    -Progress

  ! $build_app || RunUAT.sh BuildCookRun \
    -project="$UNREAL_PROJECT" \
    -noP4 \
    -platform="$platform" \
    -clientconfig=Shipping \
    -serverconfig=Shipping \
    -cook \
    -allmaps \
    -stage \
    -pak \
    -compressed \
    -nocompileeditor \
    -nocompilerelatedcode \
    -archive
}
